<!DOCTYPE html>
<html>
    <head>
{{> head }}

    </head>

    <body>
        <div class="container">

		{{> navbar }}
		
				
		<div id="menu-list-view"/>

		</div>
		
		{{< modal }}
		{{$title}}
		Menu
		{{/title}}
		{{$body}}
		<form action ="/menu/edit/" method="POST"/>
			{{< form }}
				{{$fields}}
					{{> input_field id="hello" name="name" type="text"}}
					{{> select_field }}
				{{/fields}}
			{{/ form }}
		</form>
		{{/body}}
		{{/ modal }}
		   		

        <script src="js/jquery-3.1.1.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/login.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/css/bootstrap-dialog.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/js/bootstrap-dialog.min.js"></script>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel='stylesheet' type='text/css'>

		
        <script type="text/javascript">
  			$(document).ready(function() {
  			
  				var current_page = 1 ;
  				var results_per_view = 10 ;
  				
  				
				function onNewRecord() 	{

					var msg = $('<div></div>').load("/menu/create/", 
						function(response, status, xhr) {
							var dialog = new BootstrapDialog({ 
								title: 'New Menu',
								message: msg
							});
							
							dialog.realize() ;
							dialog.open() ;
        
							var form = msg.find('form') ;
							form.submit(function(e) {

								$.ajax({
									type: "POST",
									dataType: "json",
									url: "/menu/create/",
									data: form.serialize(), // serializes the form's elements.
									success: function(data)
									{
										if ( data.success ) {
											dialog.close() ;
											reload() ;
										}
										else {
											form.html(data.content) ;
										}
									} 
								});
								
								e.preventDefault() ;
							}) ;
						}) ;
				} ;
				
				function onEditRecord() 	{

					var id = $(this).closest('tr').data('id') ;
					var msg = $('<div></div>').load("/menu/update/", $.param({id: id}),
						function(response, status, xhr) {
							var dialog = new BootstrapDialog({ 
								title: 'Edit Record',
								message: msg
							});
							
							dialog.realize() ;
							dialog.open() ;
        
							var form = msg.find('form') ;
							form.submit(function(e) {
								var data = $(form).serializeArray();
								data.push({id: id});

								$.ajax({
									type: "POST",
									dataType: "json",
									url: "/menu/update/",
									data: data,
									success: function(data)
									{
										if ( data.success ) {
											dialog.close() ;
											reload() ;
										}
										else {
											form.html(data.content) ;
										}
									} 
								});
								
								e.preventDefault() ;
							}) ;
						}) ;
				} ;
				
				function onDeleteRecord() {
					var id = $(this).closest('tr').data('id') ;
					 $.ajax({
	        			url: '/menu/delete/',
			    	    type: 'POST',
			    	    dataType: 'json',
	        			data: { 'id': id },
	        			cache: false,
	        			success: function(data, textStatus, jqXHR)
	        			{
							reload() ;
			    	    },
	        			error: function(jqXHR, textStatus, errorThrown)
	        			{
	        			    // Handle errors here
	        			    console.log('ERRORS: ' + textStatus);
	        			    // STOP LOADING SPINNER
	        			}
			    	}) ;
				
				}
  				
  				function reload() {
  		
					$('#menu-list-view').load("/menu/list/", $.param({page: current_page, total: results_per_view}), function(response, status, xhr) {
						var item = $(this) ;
						
						// add handler for pager links
						$(item).find('#pager li a').click(function(e) {
							e.preventDefault() ;
							current_page = $(this).data('page') ;
							reload() ;
						}) ;
						
						// select correct button in results per view group
						
						var rpv_buttons = $(item).find('#results-per-page input') ;
						
						$(rpv_buttons).each(function(item, value) {
							if ( $(value).val() == results_per_view ) $(value).parent().addClass("active") ;
							else $(value).parent().removeClass("active") ;
						}) ;
						
						// assure that the current page is within range
						var num_pages = $(item).find('ul').data('total-pages') ;
						if ( current_page > num_pages ) current_page = 1 ;
						
						// handle results per view change

						$(rpv_buttons).change(function(){
							results_per_view = $(this).val() ;
							reload() ;
						})
						
						// handle new record action
						
		  				$(item).find('#new-record').click(onNewRecord) ;
		  				
		  				// handle detete record
		  				$(item).find('#data-grid #delete-button').click(onDeleteRecord) ;
		  				
						// handle edit record
		  				$(item).find('#data-grid #edit-button').click(onEditRecord) ;
					}) ;
				}
				
				reload() ;
					
         			
        		
			});
		
		</script>
    </body>
</html>
